<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel Empresa | ConectaU</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="new_style.css" />
  <link rel="stylesheet" href="dashboard.css" />
</head>
<body>
  <nav class="nav">
    <div class="brand">
      <div class="logo"><img src="logo.png" alt="ConectaU" /></div>
      <div>
        <h1>ConectaU</h1>
        <p>Panel de Empresa</p>
      </div>
    </div>
    <div class="nav-actions">
      <button onclick="cambiarPerfil()" class="btn-primary">Cambiar a Estudiante</button>
      <button onclick="cerrarSesion()" class="btn-logout">Cerrar sesión</button>
    </div>
  </nav>

  <!-- shared helpers -->
  <script src="shared.js"></script>

  <div class="container">
    <div class="header" style="align-items:flex-start">
      <div class="header-left">
        <h2 id="welcomeMessage">Gestión de Vacantes</h2>
        <p class="muted" style="margin-top:6px">Publica tus vacantes, revisa postulaciones y conecta con talento universitario.</p>
      </div>

      <div class="header-right">
        <div class="stat-cards">
          <div class="stat-card">
            <div class="stat-number" id="totalVacantes">0</div>
            <div class="stat-label">Vacantes publicadas</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalPostulaciones">0</div>
            <div class="stat-label">Postulaciones recibidas</div>
          </div>
        </div>
      </div>
    </div>


    <div class="dashboard dashboard-grid">
      <aside>
        <form id="vacanteForm" class="form card">
          <h3>Publicar Nueva Vacante</h3>
          <div class="form-group">
            <input type="text" id="titulo" placeholder="Título del proyecto" required />
          </div>
          <div class="form-group">
            <textarea id="descripcion" placeholder="Descripción detallada del proyecto" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <select id="modalidad" required>
              <option value="">Selecciona la modalidad</option>
              <option value="Remoto">Remoto</option>
              <option value="Presencial">Presencial</option>
              <option value="Híbrido">Híbrido</option>
            </select>
          </div>
          <div class="form-group">
            <input type="text" id="ubicacion" placeholder="Ubicación (ciudad o remoto)" required />
          </div>
          <div class="form-group">
            <input type="number" id="pago" placeholder="Pago mensual en COP" required />
          </div>
          <div class="form-group">
            <input type="text" id="habilidades" placeholder="Habilidades requeridas (separadas por coma)" required />
          </div>
          <button type="submit" class="btn-primary">Publicar Vacante</button>
        </form>
      </aside>

      <section>
        <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Mis Vacantes</h3>
          <div class="muted">Pulsa "Ver postulaciones" para revisar candidatos</div>
        </div>
        <div id="misVacantes" class="vacantes-grid">
          <!-- Las vacantes se cargarán aquí -->
        </div>
      </section>
    </div>
  </div>

  <div id="toast" style="display:none"></div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      query, 
      where, 
      orderBy,
      Timestamp,
      doc,
      getDoc,
      deleteDoc,
      updateDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA9USwOBgrunZQZcBCQFd8Fx0UJTytZ8_s",
      authDomain: "conectau-16a34.firebaseapp.com",
      projectId: "conectau-16a34",
      storageBucket: "conectau-16a34.appspot.com",
      messagingSenderId: "557099346827",
      appId: "1:557099346827:web:13509cb4bf9c9921615d8e",
      measurementId: "G-JSE7B6KR38"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

  // Verificar autenticación (usando API modular)
  onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      try {
        // Obtener datos de la empresa
        const userDocSnap = await getDocs(query(collection(db, 'users'), where('email', '==', user.email)));
        const empresaData = userDocSnap.empty ? { name: 'Empresa' } : userDocSnap.docs[0].data();

        // Mostrar nombre de la empresa en el header
        const header = document.querySelector('.header h2');
        header.textContent = `Panel de ${empresaData.name}`;

        // Use realtime listeners for vacantes and postulaciones so UI updates without reloads
        const vacantesContainer = document.getElementById('misVacantes');
        vacantesContainer.innerHTML = '';

        const vacantesQuery = query(collection(db, 'vacantes'), where('empresaId', '==', user.uid));
        const postulQuery = query(collection(db, 'postulaciones'), where('empresaId', '==', user.uid));

        let latestVacantes = [];
        let postulCounts = {};

        // Listen postulaciones for counts and total
        onSnapshot(postulQuery, snap => {
          postulCounts = {};
          snap.forEach(d => {
            const pd = d.data();
            const vid = pd.vacanteId;
            postulCounts[vid] = (postulCounts[vid] || 0) + 1;
          });
          document.getElementById('totalPostulaciones').textContent = snap.size;
          // re-render vacantes with updated counts
          renderVacantes(latestVacantes, postulCounts, empresaData);
        }, err => console.warn('postulaciones listener error', err));

        // Listen vacantes for this empresa
        onSnapshot(vacantesQuery, snap => {
          latestVacantes = snap.docs.map(d => {
            const data = d.data();
            const fecha = data.fecha && data.fecha.toDate ? data.fecha.toDate() : (data.fecha ? new Date(data.fecha) : new Date(0));
            return { id: d.id, ...data, fecha };
          }).sort((a,b) => b.fecha - a.fecha);

          document.getElementById('totalVacantes').textContent = latestVacantes.length;
          renderVacantes(latestVacantes, postulCounts, empresaData);
        }, err => console.warn('vacantes listener error', err));

        function renderVacantes(vacantes, counts, empresaData) {
          vacantesContainer.innerHTML = '';
          if (!vacantes || vacantes.length === 0) {
            vacantesContainer.innerHTML = '<p class="no-vacantes">No has publicado vacantes aún.</p>';
            return;
          }
          for (const vacante of vacantes) {
            const vacanteId = vacante.id;
            const count = counts[vacanteId] || 0;
            const card = document.createElement('div');
            card.className = 'vacante';
            card.innerHTML = `
              <div class="vacante-header">
                <h3 class="vacante-title">${vacante.titulo}</h3>
                <p class="vacante-company">${vacante.empresaNombre || empresaData.name}</p>
              </div>
              <div class="vacante-tags">
                <span class="tag tag-modalidad">${vacante.modalidad}</span>
                <span class="tag tag-salary">$${(vacante.pago || 0).toLocaleString()}</span>
              </div>
              <p class="vacante-description">${vacante.descripcion}</p>
              <div class="vacante-skills">
                ${(vacante.habilidades || []).map(h=>`<span class="skill">${h}</span>`).join('')}
              </div>
              <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn-postular" onclick="verPostulaciones('${vacanteId}')">Ver postulaciones (${count})</button>
                <button class="btn" onclick="editarVacante('${vacanteId}')">Editar</button>
              </div>
            `;
            vacantesContainer.appendChild(card);
          }
        }

      } catch (error) {
        console.error('Error cargando panel de empresa:', error);
        // Mostrar mensaje más detallado para depuración
        alert('Error al cargar el panel de empresa: ' + (error && error.message ? error.message : String(error)));
      }
    });

    // Global error handler to help debugging in local files
    window.addEventListener('error', (e) => {
      console.error('Unhandled error:', e.error || e.message || e);
      // show compact alert to user with error message
      try { alert('Error de script: ' + (e.error && e.error.message ? e.error.message : (e.message || String(e)))); } catch (err) { /* ignore */ }
    });

    // Manejar el formulario de vacantes (con validación)
    const vacanteForm = document.getElementById('vacanteForm');
    vacanteForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitButton = vacanteForm.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.textContent = 'Publicando...';
      
      try {
        // client-side validation using shared helper
        const validation = window.validateVacanteForm(vacanteForm);
        if (!validation.valid) {
          window.showFormErrors(vacanteForm, validation.errors);
          return;
        }
        const user = auth.currentUser;
        if (!user) throw new Error('Debes iniciar sesión');

        const userData = (await getDocs(query(collection(db, 'users'), where('email', '==', user.email)))).docs[0].data();
        
        const vacante = {
          empresaId: user.uid,
          empresaNombre: userData.name,
          titulo: vacanteForm.titulo.value,
          descripcion: vacanteForm.descripcion.value,
          modalidad: vacanteForm.modalidad.value,
          ubicacion: vacanteForm.ubicacion.value,
          pago: parseInt(vacanteForm.pago.value),
          habilidades: vacanteForm.habilidades.value.split(',').map(h => h.trim()),
          fecha: new Date(),
          estado: 'activa'
        };
        // Si el formulario tiene un dataset.editId, actualizar la vacante existente
        if (vacanteForm.dataset.editId) {
          const editId = vacanteForm.dataset.editId;
          const vacRef = doc(db, 'vacantes', editId);
          // No sobreescribimos fecha original a menos que se desee
          await updateDoc(vacRef, vacante);
          alert('Vacante actualizada correctamente');
          delete vacanteForm.dataset.editId;
          vacanteForm.querySelector('button[type="submit"]').textContent = 'Publicar Vacante';
          vacanteForm.reset();
          // UI will refresh via onSnapshot listener
        } else {
          await addDoc(collection(db, 'vacantes'), vacante);
          alert('Vacante publicada exitosamente');
          vacanteForm.reset();
          // UI will refresh via onSnapshot listener
        }
        
      } catch (error) {
        console.error('Error:', error);
        alert('Error al publicar la vacante: ' + error.message);
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Publicar';
      }
    });

    // Ver postulaciones de una vacante (modal integrado con acciones)
    window.verPostulaciones = async (vacanteId) => {
      try {
        const postulSnap = await getDocs(query(collection(db, 'postulaciones'), where('vacanteId', '==', vacanteId)));
        if (postulSnap.empty) {
          alert('No hay postulaciones para esta vacante.');
          return;
        }

        // Build modal overlay
        const modalRootId = 'empresaModalRoot';
        let root = document.getElementById(modalRootId);
        if (!root) { root = document.createElement('div'); root.id = modalRootId; document.body.appendChild(root); }
        root.innerHTML = '';
        root.className = 'cu-modal-overlay';

        const modal = document.createElement('div');
        modal.className = 'cu-modal';
        modal.innerHTML = `<h3>Postulaciones - Vacante</h3>`;

        for (const p of postulSnap.docs) {
          const pd = p.data();
          const pid = p.id;
          // Prefer data embedded in postulacion but also try to fetch full user profile
          let studentName = pd.estudianteNombre || pd.estudianteId;
          let studentEmail = pd.estudianteEmail || '';
          let studentExtra = {};
          try {
            const userRef = doc(db, 'users', pd.estudianteId);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
              const ud = userSnap.data();
              studentName = ud.name || studentName;
              studentEmail = ud.email || studentEmail;
              studentExtra.university = ud.university || '';
              studentExtra.career = ud.career || '';
              studentExtra.skills = ud.skills || [];
            }
          } catch (__) { /* ignore */ }

          const fecha = pd.fecha && pd.fecha.toDate ? new Date(pd.fecha.toDate()).toLocaleString() : (pd.fecha ? new Date(pd.fecha).toLocaleString() : '');

          const applicantDiv = document.createElement('div');
          applicantDiv.className = 'applicant';
          applicantDiv.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>${studentName}</strong>
                <div class="muted">${studentEmail}</div>
                <div class="muted">Usuario: ${pd.estudianteId}</div>
                ${studentExtra.university ? `<div class="muted">Universidad: ${studentExtra.university}</div>` : ''}
                ${studentExtra.career ? `<div class="muted">Carrera: ${studentExtra.career}</div>` : ''}
                ${studentExtra.skills && studentExtra.skills.length ? `<div class="muted">Habilidades: ${studentExtra.skills.join(', ')}</div>` : ''}
              <div class="muted">Fecha: ${fecha}</div>
              ${pd.disponibilidad ? `<div class="muted">Disponibilidad: ${pd.disponibilidad}</div>` : ''}
              <div class="muted">Estado: <span class="cu-badge">${pd.estado || 'pendiente'}</span></div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px">
                <button class="btn" data-action="accept" data-id="${pid}">Aceptar</button>
                <button class="btn-outline" data-action="reject" data-id="${pid}">Rechazar</button>
              </div>
            </div>
          `;

          modal.appendChild(applicantDiv);
        }

        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Cerrar';
        closeBtn.className = 'btn-outline';
        closeBtn.style.marginTop = '12px';
        closeBtn.onclick = () => { root.remove(); };
        modal.appendChild(closeBtn);

        root.appendChild(modal);

        // Delegate actions
        modal.addEventListener('click', async (ev) => {
          const btn = ev.target.closest('button[data-action]');
          if (!btn) return;
          const action = btn.getAttribute('data-action');
          const id = btn.getAttribute('data-id');

          try {
            const docRef = doc(db, 'postulaciones', id);
            if (action === 'accept') {
              await updateDoc(docRef, { estado: 'aceptado' });
              btn.textContent = 'Aceptado'; btn.disabled = true; btn.style.opacity = 0.7;
            } else if (action === 'reject') {
              await updateDoc(docRef, { estado: 'rechazado' });
              btn.textContent = 'Rechazado'; btn.disabled = true; btn.style.opacity = 0.7;
            }
          } catch (err) {
            console.error('Error actualizando postulacion', err);
            alert('No se pudo actualizar la postulación');
          }
        });

      } catch (error) {
        console.error('Error obteniendo postulaciones:', error);
        alert('Error al obtener las postulaciones');
      }
    };

    window.editarVacante = async (vacanteId) => {
      try {
        const vacRef = doc(db, 'vacantes', vacanteId);
        const vacSnap = await getDoc(vacRef);
        if (!vacSnap.exists()) {
          alert('Vacante no encontrada');
          return;
        }
        const data = vacSnap.data();
        // Fill the form
        vacanteForm.titulo.value = data.titulo || '';
        vacanteForm.descripcion.value = data.descripcion || '';
        vacanteForm.modalidad.value = data.modalidad || '';
        vacanteForm.ubicacion.value = data.ubicacion || '';
        vacanteForm.pago.value = data.pago || '';
        vacanteForm.habilidades.value = (data.habilidades || []).join(', ');

        // Mark form in edit mode
        vacanteForm.dataset.editId = vacanteId;
        const submitButton = vacanteForm.querySelector('button[type="submit"]');
        submitButton.textContent = 'Actualizar Vacante';
        submitButton.disabled = false;
        // Scroll to form on edit
        vacanteForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } catch (err) {
        console.error('Error cargando vacante para editar', err);
        alert('No se pudo cargar la vacante para edición');
      }
    };

    // Cambiar perfil (empresa -> estudiante)
    window.cambiarPerfil = async () => {
      try {
        window.showConfirmModal({
          title: 'Cambiar perfil',
          message: '¿Seguro que quieres cambiar tu perfil a Estudiante?',
          confirmText: 'Sí, cambiar',
          cancelText: 'Cancelar'
        }, async () => {
          const user = auth.currentUser;
          if (!user) return;
          const userRef = doc(db, 'users', user.uid);
          await updateDoc(userRef, { role: 'estudiante' });
          // Redirigir al panel de estudiante
          window.location.href = 'dashboard.html';
        });
      } catch (err) {
        console.error('Error cambiando perfil', err);
        alert('No se pudo cambiar el perfil');
      }
    };

    // Función de cierre de sesión
    window.cerrarSesion = async () => {
      try {
        await auth.signOut();
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
        alert('Error al cerrar sesión');
      }
    };
  </script>
</body>
</html>
